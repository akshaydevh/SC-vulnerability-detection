import { ethers } from "ethers";
import config from "@/config";

const contractJSON = require('@/abi/Deposit_V1.json') // Vulnerable smartcontract
const provider = new ethers.InfuraWebSocketProvider(config.NETWORK, config.INFURA_API_KEY);
const wallet = new ethers.Wallet.fromPhrase(config.MNEMONIC, provider);
const contract = new ethers.Contract(config.CONTRACT_ADDRESS, contractJSON.abi, wallet);

const watchAndPause = async () => {
    try {
        contract.on("reentrancy", async (attacker, event) => {
            try {
                /**
                 * REENTRANCY CONFIRMED
                 * *********************
                 * This event is emiited when a reentrancy attack is confirmed.
                 * This event is triggered by the reentrancy modifier, inspired.
                 * from oppenzepplin reentrancyGuard.
                 * *********************
                 */

                // getting data from event log
                const txHash = event?.log?.transactionHash;
                const txData = await provider.getTransaction(txHash);
                const providedGasPrice = txData.gasPrice;
                const nonce = txData.nonce;

                // send a new transaction with updated gas price to 

                console.warn("ATTACK DETECTED: Reentrancy confirmed");
                console.log(`attacker: ${attacker}`);
                console.log(`txHash: ${txHash}`);

                // send a front running transaction 
                const gasPrice = await provider.getGasPrice(); // get current gas price 
                const increasedGasPrice = gasPrice.mul(ethers.BigNumber.from(2)); // double the price

                // check if this price is greater than provideGasPrice
                const newGasPrice = providedGasPrice.gt(increasedGasPrice) ?
                    ethers.BigNumber.from(10000).add(ethers.BigNumber.from(providedGasPrice)) : increasedGasPrice;

                console.log("Attempting to block the transaction......");
                const tx = await contract.pause({
                    gasPrice: newGasPrice,
                    nonce: nonce,
                })
                const txReceipt = await tx.wait();
                console.log(`succefully blocked the transaction with hash: ${txReceipt.transactionHash}`);

            } catch (error) {
                console.error("Error handling reentrancy event:", error);
            }
        })
    } catch (error) {
        console.error("Error watching contract:", error);
    }
}

export default {
    watchAndPause
}